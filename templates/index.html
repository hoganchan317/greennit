<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>首页 - Greennit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>html{visibility:hidden}</style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
<div class="max-w-6xl mx-auto px-4 py-8">

  {% set hide_back = true %}
  {% include "_navbar.html" %}

    <!-- 板块 / Topics 区域 -->
    <div class="mb-10">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">板块 / Topics</h2>
            {% if username %}
                <a href="/topic/new"
                   class="px-3 py-1 bg-sky-500 rounded text-sm font-semibold">
                    创建新板块
                </a>
            {% endif %}
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% if topics %}
                {% for t in topics %}
                    <a href="/topic/{{ t[0] }}"
                       class="block bg-slate-800/80 rounded-xl p-4 hover:bg-slate-700 transition text-center">
                        <div class="text-lg font-semibold mb-1">{{ t[1] }}</div>
                        <div class="text-xs text-slate-400">点击进入</div>
                    </a>
                {% endfor %}
            {% else %}
                <div class="col-span-4 text-center text-slate-400 py-6">
                    还没有任何板块，用户可以在「创建新板块」提交申请，管理员在管理中心审核通过。
                </div>
            {% endif %}
        </div>
    </div>
    <!-- 最受欢迎帖子 -->
    <div class="mb-10">
        <h2 class="text-xl font-bold mb-4">最受欢迎帖子</h2>

        <div class="space-y-3">
            {% if top_posts %}
                {% for p in top_posts %}
                    <!-- p: (id, title, content, created_at, username, topic_name, like_count) -->
                    <div class="bg-slate-800/80 rounded-xl p-3 flex justify-between items-center hover:bg-slate-700 transition">
                        <div>
                            <a href="/post/{{ p[0] }}" class="font-semibold hover:underline">
                                {{ p[1] }}
                            </a>
                            <div class="text-xs text-slate-400 mt-1">
                                {% if p[5] %}
                                    <span class="text-emerald-300 mr-1">[{{ p[5] }}]</span>
                                {% endif %}
                                by {{ p[4] }} · {{ p[3].strftime('%Y-%m-%d %H:%M') if p[3] else '' }}
                            </div>
                        </div>
                        <div class="text-xs text-emerald-300">
                            ❤ {{ p[6] or 0 }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-sm text-slate-400">
                    还没有受欢迎的帖子，快去点个赞吧～
                </div>
            {% endif %}
        </div>
    </div>
    <!-- 帖子列表 -->
    <div>
        <h2 class="text-xl font-bold mb-4">最新帖子</h2>

        <div id="post-list" class="space-y-4">
            {% if posts %}
                {% for p in posts %}
                    <!-- p: (id, title, content, created_at, username, topic_name, likes) -->
                    <div class="post-card bg-slate-800/80 rounded-xl p-4 hover:bg-slate-700 transition"
                         data-post-id="{{ p[0] }}">
                        <div class="flex justify-between items-center mb-1">
                            <a href="/post/{{ p[0] }}" class="text-xl font-semibold hover:underline">
                                {{ p[1] }}
                            </a>
                            <div class="flex items-center gap-2">
                                <span class="text-xs opacity-70">
                                    {% if p[5] %}
                                        <span class="text-emerald-300 mr-1">[{{ p[5] }}]</span>
                                    {% endif %}
                                    by {{ p[4] }} · {{ p[3].strftime('%Y-%m-%d %H:%M') if p[3] else '' }}
                                </span>
                                {% if is_admin %}
                                    <form method="post"
                                          action="/admin/post/{{ p[0] }}/delete"
                                          onsubmit="return confirm('确定要删除这篇帖子吗？');">
                                        <button class="text-xs text-red-400 border border-red-500/50 px-2 py-1 rounded hover:bg-red-500/20">
                                            删帖
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-1 text-xs text-slate-400">
                            <div>
                                ❤ <span class="like-count">{{ p[6] }}</span>
                            </div>
                            {% if username %}
                                <button class="like-btn text-xs px-2 py-1 rounded border border-rose-400/60 text-rose-300 hover:bg-rose-500/20">
                                    点赞 / 取消赞
                                </button>
                            {% else %}
                                <span class="text-slate-500">登录后可以点赞</span>
                            {% endif %}
                        </div>

                        <p class="text-sm opacity-80 line-clamp-2">
                            {{ p[2][:160] }}{% if p[2]|length > 160 %}...{% endif %}
                        </p>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center text-slate-400 py-8">
                    还没有任何帖子，快去发第一帖吧！
                </div>
            {% endif %}
        </div>

        {% if total_pages and total_pages > 1 %}
        <div class="mt-6 flex justify-center items-center gap-4 text-sm text-slate-300">
            {% if has_prev %}
            <a href="/?page={{ page - 1 }}"
               class="px-3 py-1 rounded bg-slate-800 hover:bg-slate-700">
                上一页
            </a>
            {% else %}
            <span class="px-3 py-1 rounded bg-slate-800/40 text-slate-500 cursor-not-allowed">
                上一页
            </span>
            {% endif %}

            <span>第 {{ page }} / {{ total_pages }} 页</span>

            {% if has_next %}
            <a href="/?page={{ page + 1 }}"
               class="px-3 py-1 rounded bg-slate-800 hover:bg-slate-700">
                下一页
            </a>
            {% else %}
            <span class="px-3 py-1 rounded bg-slate-800/40 text-slate-500 cursor-not-allowed">
                下一页
            </span>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

{% if username %}
<script>
  // 绑定点赞按钮
  function bindLikeButtons() {
    document.querySelectorAll(".post-card .like-btn").forEach(btn => {
      if (btn._bound) return;
      btn._bound = true;
      btn.addEventListener("click", async () => {
        const card = btn.closest(".post-card");
        const postId = card.getAttribute("data-post-id");
        const countSpan = card.querySelector(".like-count");

        try {
          const res = await fetch(`/api/post/${postId}/like`, { method: "POST" });
          if (!res.ok) return;
          const data = await res.json();
          if (countSpan) countSpan.textContent = data.likes;
        } catch (err) {
          console.error("Like API error", err);
        }
      });
    });
  }

  bindLikeButtons();

  // 简单实时刷新帖子列表：每 5 秒从 /api/posts 拉一次
  async function refreshPosts() {
    try {
      const res = await fetch("/api/posts");
      if (!res.ok) {
        console.error("Failed to load posts", res.status);
        return;
      }
      const data = await res.json(); // data 是帖子数组
      const list = document.getElementById("post-list");
      if (!list) return;

      const existing = new Map();
      list.querySelectorAll(".post-card").forEach(card => {
        existing.set(card.getAttribute("data-post-id"), card);
      });

      const newCards = [];

      for (const p of data) {
        const idStr = String(p.id);
        let card = existing.get(idStr);
        if (!card) {
          card = document.createElement("div");
          card.className = "post-card bg-slate-800/80 rounded-xl p-4 hover:bg-slate-700 transition";
          card.setAttribute("data-post-id", idStr);
          card.innerHTML = `
            <div class="flex justify-between items-center mb-1">
              <a href="/post/${p.id}" class="text-xl font-semibold hover:underline">
                ${p.title}
              </a>
              <div class="flex items-center gap-2">
                <span class="text-xs opacity-70">
                  ${p.topic_name ? `<span class="text-emerald-300 mr-1">[${p.topic_name}]</span>` : ""}
                  by ${p.username} · ${p.created_at || ""}
                </span>
              </div>
            </div>
            <div class="flex justify-between items-center mb-1 text-xs text-slate-400">
              <div>
                ❤ <span class="like-count">${p.likes}</span>
              </div>
              <button class="like-btn text-xs px-2 py-1 rounded border border-rose-400/60 text-rose-300 hover:bg-rose-500/20">
                点赞 / 取消赞
              </button>
            </div>
            <p class="text-sm opacity-80 line-clamp-2">
              ${p.content.length > 160 ? p.content.slice(0, 160) + "..." : p.content}
            </p>
          `;
        } else {
          const likeSpan = card.querySelector(".like-count");
          if (likeSpan) likeSpan.textContent = p.likes;
        }
        newCards.push(card);
      }

      // 用新的顺序重建列表（也会自动去掉已删除的帖子）
      list.innerHTML = "";
      newCards.forEach(c => list.appendChild(c));

      // 重新绑定点赞按钮
      bindLikeButtons();

    } catch (err) {
      console.error("refreshPosts error", err);
    }
  }

  // 每 5 秒刷新一次
  setInterval(refreshPosts, 5000);
</script>
{% endif %}

<script>document.documentElement.style.visibility='visible'</script>
</body>
</html>