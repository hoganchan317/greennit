<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title>{{ post.title if post is defined else '帖子详情 - Greennit' }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>html{visibility:hidden}</style>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8">

        {% include "_navbar.html" %}

        <!-- 帖子内容（只出现一次） -->
        <main class="mt-6">
            <div class="bg-slate-800/60 rounded-lg p-6">
                {% if post %}
                    <h1 class="text-2xl font-bold">{{ post.title }}</h1>
                    <div class="text-sm text-slate-400 mt-1">by <a href="/user/{{ post.username }}" class="text-sky-300">{{ post.username }}</a> · {{ post.created_at }}</div>
                    <article class="mt-4 prose prose-invert max-w-none text-slate-200 whitespace-pre-wrap">{{ post.content }}</article>

                    <div class="mt-4 flex justify-between items-center">
                        <div class="text-xs text-slate-400">
                            {% if post.topic_name %}<span class="text-emerald-300 mr-2">[{{ post.topic_name }}]</span>{% endif %}
                            发布于 {{ post.created_at.strftime('%Y-%m-%d %H:%M') if post.created_at else '' }}
                            <span class="ml-3 text-emerald-300">❤ {{ likes_count }}</span>
                        </div>

                        <div class="flex items-center gap-2">
                            {% if username %}
                                <form method="post" action="/post/{{ post.id }}/like">
                                    <button class="text-xs px-2 py-1 rounded border {% if user_liked %}bg-rose-500/80 border-rose-400{% else %}text-rose-300 border-rose-400/60{% endif %}">{% if user_liked %}取消赞{% else %}点赞{% endif %}</button>
                                </form>
                                <form method="post" action="/report/post/{{ post.id }}" onsubmit="return confirm('确定要举报这个帖子吗？');">
                                    <button class="text-xs text-amber-300 border border-amber-400/60 px-2 py-1 rounded">举报帖子</button>
                                </form>
                                {% if is_author or is_admin %}
                                    <a href="/post/{{ post.id }}/edit" class="text-xs px-2 py-1 rounded bg-sky-500 text-white">编辑</a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>

                {% else %}
                    <div class="text-slate-400">未找到该帖子。</div>
                {% endif %}
            </div>

            <!-- 评论区 -->
            <section class="mt-6">
                <h2 class="text-lg font-semibold mb-3">评论</h2>
                <div id="comment-list" class="space-y-3">
                    {% if comments %}
                        {% for c in comments %}
                            <div class="bg-slate-800/70 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="text-xs text-slate-400">{{ c[3] }} · {{ c[2].strftime('%Y-%m-%d %H:%M') if c[2] else '' }}</div>
                                    <div class="flex items-center gap-2">
                                        {% if username and (is_admin or username == c[3]) %}
                                            <form method="post" action="/comment/{{ c[0] }}/delete" onsubmit="return confirm('确定要删除这条评论吗？');">
                                                <input type="hidden" name="post_id" value="{{ post.id }}">
                                                <button class="text-xs text-red-400 border border-red-500/50 px-2 py-1 rounded">删评</button>
                                            </form>
                                        {% endif %}
                                        {% if username %}
                                            <form method="post" action="/report/comment/{{ c[0] }}" onsubmit="return confirm('确定要举报这条评论吗？');">
                                                <input type="hidden" name="post_id" value="{{ post.id }}">
                                                <button class="text-xs text-amber-300 border border-amber-400/60 px-2 py-1 rounded">举报</button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-sm whitespace-pre-wrap">{{ c[1] }}</div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-sm text-slate-500">还没有评论，快来抢沙发～</div>
                    {% endif %}
                </div>
            </section>

            <!-- 发表评论 -->
            <section class="mt-6">
                {% if username %}
                    <form method="post" action="/comment" class="space-y-3">
                        <input type="hidden" name="post_id" value="{{ post.id }}">
                        <label class="block text-sm text-slate-300 mb-1">发表评论（{{ username }}）</label>
                        <textarea id="comment-input" name="content" rows="4" required class="w-full px-3 py-2 rounded bg-slate-800 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                        <div class="flex justify-end">
                            <button class="px-4 py-2 bg-emerald-500 rounded text-sm font-semibold">提交评论</button>
                        </div>
                    </form>
                {% else %}
                    <p class="text-sm text-slate-400 mt-2">你还没有登录，<a href="/login" class="text-emerald-400 underline">登录后才能评论</a>。</p>
                {% endif %}
            </section>
        </main>

    </div>

    <script>
        const postId = Number("{{ post.id if post is defined else 0 }}");
        const currentUser = "{{ username or '' }}";
        const commentList = document.getElementById('comment-list');
        const commentInput = document.getElementById('comment-input');

        function addCommentToDOM(c) {
            if (!commentList) return;
            // remove empty placeholder
            if (commentList.children.length === 1 && commentList.children[0].textContent.includes('还没有评论')) {
                commentList.innerHTML = '';
            }
            const div = document.createElement('div');
            div.className = 'bg-slate-800/70 rounded-lg p-3';
            div.innerHTML = `<div class="flex justify-between items-center mb-1"><div class="text-xs text-slate-400">${escapeHtml(c.username)} · ${escapeHtml(c.created_at)}</div></div><div class="text-sm whitespace-pre-wrap">${escapeHtml(c.content)}</div>`;
            commentList.appendChild(div);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        // WebSocket (comments)
        try {
            const wsProtocol = (location.protocol === 'https:') ? 'wss://' : 'ws://';
            const wsUrl = wsProtocol + location.host + '/ws/comments/' + postId;
            const ws = new WebSocket(wsUrl);

            ws.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'new_comment') {
                        if (data.username !== currentUser) addCommentToDOM(data);
                    }
                } catch (e) { console.error('WS parse', e); }
            };
        } catch (e) { console.warn('WS not available', e); }

        // typing indicator
        if (commentInput && typeof WebSocket !== 'undefined') {
            let typingTimeout = null;
            commentInput.addEventListener('input', () => {
                // send typing state if ws exists
                try {
                    if (typeof ws !== 'undefined' && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'typing', is_typing: true }));
                    }
                } catch (e) {}
                if (typingTimeout) clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    try { if (typeof ws !== 'undefined' && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'typing', is_typing: false })); } catch (e) {}
                }, 2000);
            });
        }
    </script>
    <script>document.documentElement.style.visibility='visible'</script>
</body>
</html>