<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>与 {{ other_username }} 的对话 - Greennit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>html{visibility:hidden}</style>
  <style>
    /* 与 notifications.html 保持一致的全局配色和边距 */
  </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
<div class="max-w-6xl mx-auto px-4 py-8">

  {% include "_navbar.html" %}

  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold flex items-center gap-2">与 {{ other_username }} 的对话</h1>
    <a href="/report/user/{{ other_username }}" class="text-xs px-3 py-1 rounded bg-slate-700 hover:bg-red-500 text-slate-300 hover:text-white">
      举报用户
    </a>
  </div>

  <div class="space-y-3">
    <div class="bg-slate-800/80 rounded-xl p-4 flex flex-col h-[60vh] overflow-hidden">
      <div id="messages" class="flex-1 overflow-y-auto space-y-3 px-1">
        {% if messages %}
          {% for m in messages %}
            {# m expected to have sender_id, sender_username, content, created_at #}
            <div class="flex {% if m.sender_id == current_user_id %}justify-end{% else %}justify-start{% endif %}">
              <div class="rounded-xl p-3 {% if m.sender_id == current_user_id %}bg-emerald-600/80 text-black{% else %}bg-slate-700/80 text-slate-100{% endif %} max-w-[80%]">
                <div class="text-sm">{{ m.content }}</div>
                <div class="text-xs text-slate-400 mt-1">{{ m.created_at.strftime('%Y-%m-%d %H:%M') if m.created_at }}</div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="text-center text-slate-400 py-6">暂无消息，开始聊天吧。</div>
        {% endif %}
      </div>

      <div class="mt-3">
        <form method="post" action="/messages/{{ other_username }}/send" id="sendForm" class="flex gap-2">
          <input name="content" id="contentInput" class="flex-1 rounded px-3 py-2 bg-slate-900 text-slate-100 border border-slate-700" placeholder="输入消息..." autocomplete="off" />
          <button type="submit" class="px-4 py-2 rounded bg-emerald-500 hover:bg-emerald-600">发送</button>
        </form>
      </div>
    </div>
  </div>

</div>

<script>
// 简单的 WebSocket 支持（如果后端存在 ws 路由）
(function(){
  const username = "{{ username }}";
  const other = "{{ other_username }}";
  const messagesDiv = document.getElementById('messages');
  try {
    const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/chat/' + other);
    ws.onopen = function() { messagesDiv.scrollTop = messagesDiv.scrollHeight; };
    ws.onmessage = function(ev) {
      try {
        const data = JSON.parse(ev.data);
        if (data.type === 'new_message') {
          const wrapper = document.createElement('div');
          wrapper.className = 'flex ' + (data.from === username ? 'justify-end' : 'justify-start');
          const bubble = document.createElement('div');
          bubble.className = 'rounded-xl p-3 ' + (data.from === username ? 'bg-emerald-600/80 text-black' : 'bg-slate-700/80 text-slate-100') + ' max-w-[80%]';
          bubble.innerHTML = `<div class="text-sm">${data.content}</div><div class="text-xs text-slate-400 mt-1">${data.created_at}</div>`;
          wrapper.appendChild(bubble);
          messagesDiv.appendChild(wrapper);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
      } catch(e) { console.error(e); }
    };

    // Note: form submission is left to the server to insert messages.
    // We intentionally do NOT intercept the submit event here to avoid
    // duplicate messages being sent both via WebSocket and HTTP POST.
  } catch(e) { console.warn('WebSocket 不可用', e); }
})();
</script>
<script>document.documentElement.style.visibility='visible'</script>
</body>
</html>
